<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Tahta Dash</title>
  <style>
    :root {
      color-scheme: dark;
      --arkaplan: #080d18;
      --panel: rgba(0, 0, 0, 0.56);
      --vurgu: #70efff;
      --zemin: #2a4f8f;
      --yazi: #f5f7ff;
    }

    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: "Segoe UI", Arial, sans-serif;
      color: var(--yazi);
      background: radial-gradient(circle at 22% 18%, #1a2b4f, var(--arkaplan) 56%);
      touch-action: manipulation;
    }

    #oyun {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      cursor: pointer;
    }

    #ustBilgi {
      position: fixed;
      left: 50%;
      top: 1rem;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.65rem;
      z-index: 5;
      pointer-events: none;
    }

    .rozet {
      min-width: 8.4rem;
      text-align: center;
      padding: 0.5rem 0.95rem;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.24);
      background: var(--panel);
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: clamp(0.95rem, 1.9vw, 1.2rem);
    }

    #ziplamaAlani {
      position: fixed;
      left: 1rem;
      right: 1rem;
      bottom: max(1rem, env(safe-area-inset-bottom));
      min-height: 5rem;
      z-index: 4;
      border-radius: 1rem;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      background: rgba(0, 0, 0, 0.34);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(1rem, 2.4vw, 1.35rem);
      font-weight: 800;
      letter-spacing: 0.06em;
      touch-action: manipulation;
    }

    #panel {
      position: fixed;
      inset: 0;
      z-index: 7;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(2px);
    }

    #panel.oyunda {
      display: none;
    }

    .kart {
      width: min(92vw, 620px);
      border-radius: 1rem;
      padding: clamp(1rem, 3vw, 1.5rem);
      border: 2px solid rgba(112, 239, 255, 0.6);
      background: rgba(7, 13, 26, 0.93);
      text-align: center;
    }

    .kart h1 {
      margin: 0.1rem 0 0.7rem;
      font-size: clamp(1.4rem, 4.5vw, 2.3rem);
    }

    .kart p {
      margin: 0.45rem 0;
      line-height: 1.4;
      font-size: clamp(0.95rem, 2.2vw, 1.1rem);
      opacity: 0.95;
    }

    .sonuc {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.7rem;
    }

    .sonuc strong {
      color: var(--vurgu);
    }

    button {
      margin-top: 0.8rem;
      min-width: 10rem;
      padding: 0.72rem 1rem;
      border-radius: 0.82rem;
      border: 2px solid rgba(112, 239, 255, 0.7);
      background: rgba(0, 129, 255, 0.3);
      color: var(--yazi);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      cursor: pointer;
    }

    @media (max-width: 760px) {
      #ziplamaAlani {
        min-height: 4.6rem;
      }
    }
  </style>
</head>
<body>
  <canvas id="oyun" aria-label="Geometri temalı koşu oyunu"></canvas>

  <div id="ustBilgi">
    <div id="skorYazi" class="rozet">Skor: 0</div>
    <div id="rekorYazi" class="rozet">Rekor: 0</div>
  </div>

  <div id="ziplamaAlani" aria-label="Zıplama alanı">DOKUN / TIKLA / BOŞLUK → ZIPLA</div>

  <div id="panel">
    <div class="kart">
      <h1 id="panelBaslik">Başla</h1>
      <p id="panelMetin">Küp otomatik ilerler. Ritmi yakala, zıplamaları doğru zamanda yap.</p>
      <div class="sonuc">
        <p><strong>Skor:</strong> <span id="panelSkor">0</span></p>
        <p><strong>Rekor:</strong> <span id="panelRekor">0</span></p>
      </div>
      <button id="baslatButon" type="button">Başla</button>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // ---------- DOM ----------
      const canvas = document.getElementById("oyun");
      const ctx = canvas.getContext("2d", { alpha: false });
      const panel = document.getElementById("panel");
      const panelBaslik = document.getElementById("panelBaslik");
      const panelMetin = document.getElementById("panelMetin");
      const panelSkor = document.getElementById("panelSkor");
      const panelRekor = document.getElementById("panelRekor");
      const skorYazi = document.getElementById("skorYazi");
      const rekorYazi = document.getElementById("rekorYazi");
      const baslatButon = document.getElementById("baslatButon");
      const ziplamaAlani = document.getElementById("ziplamaAlani");

      // ---------- Fizik / oyun ayarları ----------
      const OYUNCU_BOYUT = 42;
      const YERDEN_DUSME_PAYI = 140;
      const GRAVITE = 2700; // Daha hızlı akışa uyum için hafif artırıldı.
      const ZIPLAMA_DARBESI = -968;
      const DT_TAVAN = 1 / 35;
      const ZIPLAMA_BUFFER_MS = 125;
      const HIZ_CARPANI = 1.06;
      const SKOR_ARALIK_MS = 120;
      const SKOR_BASINA_ARTIS = 4;
      const BITIS_SKORU = 5000;
      const REKOR_ANAHTAR = "tahta-dash-rekor";

      // ---------- Durum ----------
      let ekran = { w: 1280, h: 720, dpr: 1 };
      let zeminY = 0;
      let oyunDurumu = "bekle"; // bekle | oynaniyor | bitti | tamamlandi

      let uzaklik = 0;
      let skor = 0;
      let skorSayaciMs = 0;
      let sonKare = performance.now();
      let sonZiplamaIstekZamani = -9999;
      let rekor = Number(localStorage.getItem(REKOR_ANAHTAR) || 0);

      const oyuncu = {
        xEkran: 0,
        y: 0,
        oncekiY: 0,
        vy: 0,
        yerde: true,
        donus: 0
      };

      const seviye = {
        platformlar: [],
        dikenler: []
      };

      function kisit(deger, min, max) {
        return Math.max(min, Math.min(max, deger));
      }

      function yerlesimAyarla() {
        ekran.dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        ekran.w = window.innerWidth;
        ekran.h = window.innerHeight;
        canvas.width = Math.floor(ekran.w * ekran.dpr);
        canvas.height = Math.floor(ekran.h * ekran.dpr);
        ctx.setTransform(ekran.dpr, 0, 0, ekran.dpr, 0, 0);

        zeminY = Math.floor(ekran.h * 0.77);
        oyuncu.xEkran = Math.floor(ekran.w * 0.22);

        seviyeUret();
        if (oyunDurumu !== "oynaniyor") oyuncuyuYereKoy();
      }

      function hizHesapla() {
        // Kademeli akış korunur; toplam tempo ~%6 daha enerjik.
        const temelHiz = 320 + kisit(skor / BITIS_SKORU, 0, 1) * 80;
        return temelHiz * HIZ_CARPANI;
      }

      function patternEkle(x, zorluk) {
        const tipler = ["tek", "cift", "uclu", "kume", "bosluk", "karma"];
        const secimAgirlik = [
          1.2 - zorluk * 0.8,
          0.6 + zorluk * 0.35,
          0.25 + zorluk * 0.4,
          0.08 + zorluk * 0.35,
          0.7 + zorluk * 0.45,
          0.03 + zorluk * 0.45
        ];

        let toplam = 0;
        for (const agirlik of secimAgirlik) toplam += agirlik;
        let rastgele = Math.random() * toplam;
        let tip = "tek";
        for (let i = 0; i < tipler.length; i += 1) {
          rastgele -= secimAgirlik[i];
          if (rastgele <= 0) {
            tip = tipler[i];
            break;
          }
        }

        const dikenW = 30;
        const dikenH = 34 + zorluk * 7;
        const tabanY = zeminY;

        const platformEkle = (px, pw) => seviye.platformlar.push({ x: px, y: zeminY, w: pw, h: 34 });
        const dikenEkle = (dx) => seviye.dikenler.push({ x: dx, y: tabanY - dikenH, w: dikenW, h: dikenH });

        if (tip === "tek") {
          platformEkle(x - 10, 130);
          dikenEkle(x + 38);
          return 240;
        }

        if (tip === "cift") {
          platformEkle(x - 10, 150);
          dikenEkle(x + 34);
          dikenEkle(x + 68);
          return 255 - zorluk * 15;
        }

        if (tip === "uclu") {
          platformEkle(x - 8, 170);
          dikenEkle(x + 30);
          dikenEkle(x + 62);
          dikenEkle(x + 94);
          return 270 - zorluk * 25;
        }

        if (tip === "kume") {
          platformEkle(x - 14, 210);
          const adet = 4 + Math.round(zorluk * 2);
          for (let i = 0; i < adet; i += 1) {
            dikenEkle(x + 28 + i * 30);
          }
          return 305 - zorluk * 30;
        }

        if (tip === "bosluk") {
          const genislik = 110 - zorluk * 35;
          platformEkle(x - 12, 56);
          platformEkle(x + 56 + genislik, 90);
          return 270 - zorluk * 35;
        }

        // karma: gap + inişte spike
        const gap = 95 - zorluk * 22;
        platformEkle(x - 12, 62);
        platformEkle(x + 64 + gap, 165);
        dikenEkle(x + 96 + gap);
        if (zorluk > 0.65) dikenEkle(x + 126 + gap);
        return 290 - zorluk * 30;
      }

      function seviyeUret() {
        seviye.platformlar.length = 0;
        seviye.dikenler.length = 0;

        // Kesintisiz taban (pixel-stable ana zemin)
        seviye.platformlar.push({ x: -600, y: zeminY, w: 999999, h: 34 });

        // Desenler: erken bölüm daha rahat, ileride daha sıkı.
        const maxDunyaUzunluk = 36000;
        let x = 560;

        while (x < maxDunyaUzunluk) {
          const oran = kisit(x / maxDunyaUzunluk, 0, 1);
          const zorluk = Math.pow(oran, 0.8);
          const sonraki = patternEkle(x, zorluk);
          const spacing = kisit(sonraki + (1 - zorluk) * 50 + Math.random() * 34, 150, 360);
          x += spacing;
        }
      }

      function oyuncuyuYereKoy() {
        oyuncu.y = zeminY - OYUNCU_BOYUT;
        oyuncu.oncekiY = oyuncu.y;
        oyuncu.vy = 0;
        oyuncu.yerde = true;
      }

      function skorCiz() {
        skorYazi.textContent = `Skor: ${Math.floor(skor)}`;
        rekorYazi.textContent = `Rekor: ${Math.floor(rekor)}`;
      }

      function oyunuBitir(basariliTamamlama) {
        oyunDurumu = basariliTamamlama ? "tamamlandi" : "bitti";
        panel.classList.remove("oyunda");

        if (Math.floor(skor) > rekor) {
          rekor = Math.floor(skor);
          localStorage.setItem(REKOR_ANAHTAR, String(rekor));
        }

        panelBaslik.textContent = basariliTamamlama ? "Oyun Bitti" : "Oyun Bitti";
        panelMetin.textContent = basariliTamamlama
          ? "Tebrikler! 5000 skora ulaştın ve bölümü tamamladın."
          : "Engellere çarptın. Ritmi yakalayıp tekrar dene.";
        baslatButon.textContent = "Tekrar Dene";
        panelSkor.textContent = Math.floor(skor);
        panelRekor.textContent = Math.floor(rekor);
        skorCiz();
      }

      function oyunuBaslat() {
        uzaklik = 0;
        skor = 0;
        skorSayaciMs = 0;
        sonZiplamaIstekZamani = -9999;
        oyuncu.donus = 0;
        oyuncuyuYereKoy();
        oyunDurumu = "oynaniyor";
        panel.classList.add("oyunda");
        skorCiz();
      }

      function atla(simdiMs) {
        sonZiplamaIstekZamani = simdiMs;
      }

      function cerceveGuncelle(dt, simdiMs) {
        const hiz = hizHesapla();
        uzaklik += hiz * dt;

        // Zıplama tamponu: yere değmeden az önce basılan inputu kaçırmaz.
        const bufferAktif = simdiMs - sonZiplamaIstekZamani <= ZIPLAMA_BUFFER_MS;
        if (bufferAktif && oyuncu.yerde) {
          oyuncu.vy = ZIPLAMA_DARBESI;
          oyuncu.yerde = false;
          sonZiplamaIstekZamani = -9999;
        }

        oyuncu.oncekiY = oyuncu.y;
        oyuncu.vy += GRAVITE * dt;
        oyuncu.y += oyuncu.vy * dt;

        const oyuncuDunyaX = uzaklik;
        const kutu = {
          x: oyuncuDunyaX - OYUNCU_BOYUT / 2,
          y: oyuncu.y,
          w: OYUNCU_BOYUT,
          h: OYUNCU_BOYUT
        };

        oyuncu.yerde = false;
        let inisY = Infinity;
        for (const p of seviye.platformlar) {
          const yatayTemas = kutu.x + kutu.w > p.x && kutu.x < p.x + p.w;
          if (!yatayTemas) continue;

          const onceAlt = oyuncu.oncekiY + OYUNCU_BOYUT;
          const simdiAlt = oyuncu.y + OYUNCU_BOYUT;
          if (onceAlt <= p.y && simdiAlt >= p.y && oyuncu.vy >= 0) {
            inisY = Math.min(inisY, p.y - OYUNCU_BOYUT);
          }
        }

        if (inisY !== Infinity) {
          oyuncu.y = inisY;
          oyuncu.vy = 0; // GD hissi: yere değince düşey hız sıfırlanır.
          oyuncu.yerde = true;
          oyuncu.donus = Math.round((oyuncu.donus / (Math.PI / 2))) * (Math.PI / 2);
        } else {
          oyuncu.donus += dt * 6.7;
        }

        if (oyuncu.y > ekran.h + YERDEN_DUSME_PAYI) {
          oyunuBitir(false);
          return;
        }

        for (const d of seviye.dikenler) {
          const carpisti =
            kutu.x < d.x + d.w &&
            kutu.x + kutu.w > d.x &&
            kutu.y < d.y + d.h &&
            kutu.y + kutu.h > d.y;
          if (carpisti) {
            oyunuBitir(false);
            return;
          }
        }

        skorSayaciMs += dt * 1000;
        while (skorSayaciMs >= SKOR_ARALIK_MS) {
          skorSayaciMs -= SKOR_ARALIK_MS;
          skor += SKOR_BASINA_ARTIS;
          if (skor >= BITIS_SKORU) {
            skor = BITIS_SKORU;
            oyunuBitir(true);
            return;
          }
        }
      }

      function dunyaXToEkranX(x) {
        return x - uzaklik + oyuncu.xEkran;
      }

      function cizArkaPlan() {
        ctx.fillStyle = "#080d18";
        ctx.fillRect(0, 0, ekran.w, ekran.h);

        const adim = 58;
        ctx.strokeStyle = "rgba(112, 239, 255, 0.08)";
        ctx.lineWidth = 1;
        for (let x = -((uzaklik * 0.2) % adim); x < ekran.w; x += adim) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, ekran.h);
          ctx.stroke();
        }
      }

      function cizSeviye() {
        ctx.fillStyle = "#2a4f8f";
        ctx.strokeStyle = "#70efff";
        ctx.lineWidth = 2;

        for (const p of seviye.platformlar) {
          const sx = dunyaXToEkranX(p.x);
          if (sx + p.w < -120 || sx > ekran.w + 120) continue;
          ctx.fillRect(sx, p.y, p.w, p.h);
          ctx.strokeRect(sx + 0.5, p.y + 0.5, p.w - 1, p.h - 1);
        }

        ctx.fillStyle = "#ff5160";
        for (const d of seviye.dikenler) {
          const sx = dunyaXToEkranX(d.x);
          if (sx + d.w < -80 || sx > ekran.w + 80) continue;
          ctx.beginPath();
          ctx.moveTo(sx, d.y + d.h);
          ctx.lineTo(sx + d.w / 2, d.y);
          ctx.lineTo(sx + d.w, d.y + d.h);
          ctx.closePath();
          ctx.fill();
        }
      }

      function cizOyuncu() {
        const x = oyuncu.xEkran - OYUNCU_BOYUT / 2;
        const y = oyuncu.y;
        ctx.save();
        ctx.translate(x + OYUNCU_BOYUT / 2, y + OYUNCU_BOYUT / 2);
        if (!oyuncu.yerde) ctx.rotate(oyuncu.donus);

        const gr = ctx.createLinearGradient(-20, -20, 20, 20);
        gr.addColorStop(0, "#6af5ff");
        gr.addColorStop(1, "#0f8dff");
        ctx.fillStyle = gr;
        ctx.fillRect(-OYUNCU_BOYUT / 2, -OYUNCU_BOYUT / 2, OYUNCU_BOYUT, OYUNCU_BOYUT);

        ctx.fillStyle = "rgba(0, 0, 0, 0.35)";
        ctx.fillRect(-10, -8, 6, 6);
        ctx.fillRect(4, -8, 6, 6);
        ctx.restore();
      }

      function dongu(simdiMs) {
        const dt = Math.min(DT_TAVAN, (simdiMs - sonKare) / 1000);
        sonKare = simdiMs;

        cizArkaPlan();
        if (oyunDurumu === "oynaniyor") {
          cerceveGuncelle(dt, simdiMs);
          skorCiz();
        }
        cizSeviye();
        cizOyuncu();

        requestAnimationFrame(dongu);
      }

      // Tüm girdiler aynı fonksiyona bağlanır: klavye / mouse / touch.
      function girdiYakala(evt) {
        evt.preventDefault();
        if (oyunDurumu !== "oynaniyor") return;
        atla(performance.now());
      }

      window.addEventListener(
        "keydown",
        (evt) => {
          if (evt.code !== "Space") return;
          girdiYakala(evt);
        },
        { passive: false }
      );

      canvas.addEventListener("pointerdown", girdiYakala, { passive: false });
      ziplamaAlani.addEventListener("pointerdown", girdiYakala, { passive: false });

      baslatButon.addEventListener("click", () => {
        oyunuBaslat();
      });

      window.addEventListener("resize", yerlesimAyarla);
      window.addEventListener("orientationchange", yerlesimAyarla);
      window.addEventListener("contextmenu", (evt) => evt.preventDefault());

      yerlesimAyarla();
      panelRekor.textContent = String(rekor);
      skorCiz();
      requestAnimationFrame((ilk) => {
        sonKare = ilk;
        requestAnimationFrame(dongu);
      });
    })();
  </script>
</body>
</html>
